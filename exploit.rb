require 'rack/utils'

class String
    def string_between_markers marker1, marker2
        self[/#{Regexp.escape(marker1)}(.*?)#{Regexp.escape(marker2)}/m, 1]
    end
end



def get_escaped_html()

    html = File.read("html/index.html")
    html = html.string_between_markers "<!-- Start -->", "<!-- End -->"
    html = html.gsub("\n", "")
    html = html.gsub("\"",'\"')

    player = File.read("html/players.html")
    player = player.string_between_markers "<!-- Start -->", "<!-- End -->"
    player = player.gsub("\n", "")
    player = player.gsub("\"",'\"')

    html2 = File.read("html/index.html")
    html2 = html2.string_between_markers "<!-- Start2 -->", "<!-- End2 -->"
    html2 = html2.gsub("\n", "")
    html2 = html2.gsub("\"",'\"')


    return  html + player + html2
end



def get_escaped_js()
    js = File.read("js/index.js")
    js = js.gsub("\n", "")
    js = js.gsub("\"",'\"')

    bu = File.read("js/buttons.js")
    bu = bu.gsub("\n", "")
    bu = bu.gsub("\"",'\"')

    q = File.read("js/quickSort.js")
    q = q.gsub("\n", "")
    q = q.gsub("\"",'\"')

    d = File.read("js/reset_delete.js")
    d = d.gsub("\n", "")
    d = d.gsub("\"",'\"')

    dl = File.read("js/download.js")
    dl = dl.gsub("\n", "")
    dl = dl.gsub("\"",'\"')

    s = File.read("js/set.js")
    s = s.gsub("\n", "")
    s = s.gsub("\"",'\"')

    u = File.read("js/upload.js")
    u = u.gsub("\n", "")
    u = u.gsub("\"",'\"')

   

    



    js = "<script>"   + u + bu + q + d + dl + s  + js  +"</script>"
    return js
end


def get_escaped_css()
    js = File.read("css/index.css")
    js = js.gsub("\n", "")
    js = js.gsub("\"",'\"')

    ps = File.read("css/players.css")
    ps = ps.gsub("\n", "")
    ps = ps.gsub("\"",'\"')

    js = "<style>" + js + ps + "</style>"
    return js
end


def make_payload(inject, num)
    selector = "#content > flo-video-player"
    command = "var payload#{num}='#{inject}';"
    command += "\n"
    command += "$('#{selector}').prepend(payload#{num});"
    return command
end


command = "var isTrue = document.getElementsByClassName(\"controlBtn startBtn\");"
command += "\n"
command += "if(isTrue.length < 1){"
command += "\n"
command += make_payload(get_escaped_html,1)
command += "\n"
command += make_payload(get_escaped_css,2)
command += "\n"
command += make_payload(get_escaped_js,3)
command += "\n"
command += "}"


File.open("payload.js", "w") do |f|
  f.write(command)
end